<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>履修登録</title>
  <link href="newstyle.css" rel="stylesheet" />
</head>
<body>
    <p id="warning" style="color: red; font-weight: bold;"></p>

  <div class="form-row">
    <h1>1年</h1>
    <p class="year">学年：
      <select id="year" name="year">
        <option value="1">１年</option>
        <option value="2">２年</option>
      </select>
    </p>
    <p class="class">クラス：
      <select name="class" id="class">
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
        <option value="D">D</option>
        <option value="E">E</option>
        <option value="F">F</option>
        <option value="G">G</option>
        <option value="H">H</option>
        <option value="I">I</option>
        <option value="J">J</option>
        <option value="K">K</option>
        <option value="L">L</option>
      </select>
    </p>
    <p class="course">コース：
      <select name="course" id="course">
        <option value="nocourse">未配属</option>
        <option value="siscourse">情報システムコース</option>
        <option value="descourse">情報デザインコース</option>
        <option value="comcourse">複雑系コース</option>
        <option value="intcourse">知能システムコース</option>
      </select>
    </p>
  </div>

  <div style="margin-top: 20px;">
  <button onclick="confirmSchedule()">時間割を確定する</button>
</div>

<div id="confirmedScheduleContainer"></div>




  <div class="timetable">
    <table border="1">
      <tr>
        <th></th>
        <th>月</th>
        <th>火</th>
        <th>水</th>
        <th>木</th>
        <th>金</th>
      </tr>
      <tr>
        <td>1</td>
        <td id="mon1"></td>
        <td id="tue1"></td>
        <td id="wed1"></td>
        <td id="thu1"></td>
        <td id="fri1"></td>
      </tr>
      <tr>
        <td>2</td>
        <td id="mon2"></td>
        <td id="tue2"></td>
        <td id="wed2"></td>
        <td id="thu2"></td>
        <td id="fri2"></td>
      </tr>
      <tr>
        <td>3</td>
        <td id="mon3"></td>
        <td id="tue3"></td>
        <td id="wed3"></td>
        <td id="thu3"></td>
        <td id="fri3"></td>
      </tr>
      <tr>
        <td>4</td>
        <td id="mon4"></td>
        <td id="tue4"></td>
        <td id="wed4"></td>
        <td id="thu4"></td>
        <td id="fri4"></td>
      </tr>
      <tr>
        <td>5</td>
        <td id="mon5"></td>
        <td id="tue5"></td>
        <td id="wed5"></td>
        <td id="thu5"></td>
        <td id="fri5"></td>
      </tr>
    </table>
  </div>

  


  <script>
  let timetableData = {};

  const selectableSubjects = [
    {
      "dayperiod": "mon2",
      "classes": ["G", "H", "I", "J", "K", "L"],
      "options": ["", "電子工学基礎", "環境と産業"]
    },
    {
      "dayperiod": "mon2",
      "classes": ["E", "F"],
      "options": ["",  "環境と産業"]
    },
    {
      "dayperiod": "mon3",
      "classes": ["G", "H"],
      "options": ["", "余暇と健康Ⅱ"]
    },
    {
      "dayperiod": "fri1",
      "classes": ["A", "B", "C", "D","E","F","G","H","I","J","K","L"],
      "options": ["", "データサイエンス入門"]
    },
    {
      "dayperiod": "fri2",
      "classes": ["A", "B", "C", "D","E","F","G","H","I","J","K","L"],
      "options": ["", "ブレインサイエンス"]
    },
    {
      "dayperiod": "fri3",
      "classes": ["A", "B", "E","F","G","H"],
      "options": ["", "発達と学習"]
    },
    {
      "dayperiod": "fri5",
      "classes": ["A", "B","E","F","G","H","I","J","K","L"],
      "options": ["", "起業家としての自立"]
    },
    {
      "dayperiod": "fri5",
      "classes": ["A", "B","E","F","G","H","K","L"],
      "options": ["", "3Q:コミュニケーション論"]
    },
    {
      "dayperiod": "mon3",
      "classes": ["A", "B", "C", "D","E","F","I","J","K","L"],
      "options": ["", "社会思想の歩み"]
    },
    {
      "dayperiod": "tue2",
      "classes": ["A", "B","C","D", "E","F"],
      "options": ["", "電子工学基礎"]
    },
    {
      "dayperiod": "tue2",
      "classes": ["A", "B","E","F","G","H","K","L"],
      "options": ["", "3Q:コミュニケーション論"]
    },
    {
      "dayperiod": "tue3",
      "classes": ["K", "L"],
      "options": ["", "余暇と健康Ⅱ"]
    },
    {
      "dayperiod": "tue4",
      "classes": ["A", "B", "C", "G","H","I","J","K","L"],
      "options": ["", "社会と経済の把握"]
    },
    {
      "dayperiod": "tue5",
      "classes": ["A", "B", "C", "D","E","F","G","H","I","J","K","L"],
      "options": ["", "海の科学"]
    },
    {
      "dayperiod": "wed2",
      "classes": ["E","F"],
      "options": ["", "余暇と健康Ⅱ"]
    },
    {
      "dayperiod": "wed3",
      "classes": ["C","D"],
      "options": ["", "余暇と健康Ⅱ"]
    },
    {
      "dayperiod": "wed5",
      "classes": ["A", "B", "C", "D","G","H","I","J","K","L"],
      "options": ["", "心理学"]
    },
    {
      "dayperiod": "thu2",
      "classes": ["A", "B"],
      "options": ["", "余暇と健康Ⅱ"]
    },
    {
      "dayperiod": "thu3",
      "classes": ["I", "J"],
      "options": ["", "余暇と健康Ⅱ"]
    },
    {
      "dayperiod": "thu5",
      "classes": ["A", "B", "C", "D","E","F","I","J","K","L"],
      "options": ["", "現代デザイン論","情報産業論"]
    }
    // 他の選択科目も必要に応じて追加してください
  ];

  const linkedSubjects = [
    {
      subject: "3Q:コミュニケーション論",
      dayperiods: ["tue2", "fri5"]
    }
  ];

  fetch('timetable.json')
    .then(res => res.json())
    .then(data => {
      timetableData = data;
      setupListeners();
      updateSubject();
    });

  function setupListeners() {
    document.getElementById('year').addEventListener('change', updateSubject);
    document.getElementById('class').addEventListener('change', updateSubject);
    document.getElementById('course').addEventListener('change', updateSubject);
  }

  function updateSubject() {
    const year = document.getElementById('year').value;
    const course = document.getElementById('course').value;
    const selectedClass = document.getElementById('class').value;
    const days = ["mon", "tue", "wed", "thu", "fri"];
    const periods = [1, 2, 3, 4, 5];

    for (const day of days) {
      for (const period of periods) {
        const cellId = `${day}${period}`;
        const cell = document.getElementById(cellId);
        const isSelectable = selectableSubjects.some(item => item.dayperiod === cellId && item.classes.includes(selectedClass));
        if (cell) {
          if (isSelectable) {
            cell.innerHTML = "";
          } else {
            cell.textContent = "未設定";
          }
        }
      }
    }

    const yearData = timetableData[year]?.[course];
    if (!yearData) return;

    for (const group in yearData) {
      const groupData = yearData[group];
      if (!groupData.classes || !groupData.classes.includes(selectedClass)) continue;

      for (const key in groupData) {
        if (key === "classes") continue;

        const isSelectable = selectableSubjects.some(item =>
          item.dayperiod === key && item.classes.includes(selectedClass)
        );
        if (isSelectable) continue;

        const cell = document.getElementById(key);
        if (cell) cell.textContent = groupData[key];
      }
    }

    for (const item of selectableSubjects) {
      if (!item.classes.includes(selectedClass)) continue;

      const cell = document.getElementById(item.dayperiod);
      if (!cell) continue;

      const selectHTML = `
        <select onchange="handleSelectChange(event, '${item.dayperiod}', ${JSON.stringify(item.options)})">
          ${item.options.map(opt => `<option value="${opt}">${opt || '選択してください'}</option>`).join('')}
        </select>
      `;
      cell.innerHTML = selectHTML;
    }
  }

  function handleSelectChange(event, cellId, options) {
    const selected = event.target.value;
    const cell = document.getElementById(cellId);

    if (selected) {
      cell.textContent = selected;

      // 他のリンクセルも変更
      for (const link of linkedSubjects) {
        if (link.subject === selected && link.dayperiods.includes(cellId)) {
          for (const dp of link.dayperiods) {
            const linkedCell = document.getElementById(dp);
            if (!linkedCell) continue;
            if (dp === cellId) continue;
            linkedCell.textContent = selected;
          }
        }
      }
    } else {
      cell.innerHTML = `
        <select onchange="handleSelectChange(event, '${cellId}', ${JSON.stringify(options)})">
          ${options.map(opt => `<option value="${opt}">${opt || '選択してください'}</option>`).join('')}
        </select>
      `;
    }
  }

  function confirmSchedule() {
  const days = ["mon", "tue", "wed", "thu", "fri"];
  const periods = [1, 2, 3, 4, 5];
  const selectedClass = document.getElementById("class").value;
  const container = document.getElementById("confirmedScheduleContainer");
  container.innerHTML = ""; // 一旦リセット

  // コミュニケーション論の選択確認
  const tue2Cell = document.getElementById("tue2");
  const fri5Cell = document.getElementById("fri5");

  const tue2Value = tue2Cell.querySelector("select") ? tue2Cell.querySelector("select").value : tue2Cell.textContent.trim();
  const fri5Value = fri5Cell.querySelector("select") ? fri5Cell.querySelector("select").value : fri5Cell.textContent.trim();

  const hasOneComm = 
    (tue2Value === "3Q:コミュニケーション論" && (!fri5Value || fri5Value === "未選択" || fri5Value === ""))
    || (fri5Value === "3Q:コミュニケーション論" && (!tue2Value || tue2Value === "未選択" || tue2Value === ""));

  if (hasOneComm) {
    container.innerHTML = `<p style="color:red; font-weight:bold;">もう片方のコミュニケーション論を選択してください</p>`;
    return; // 表を表示せず終了
  }

  // 時間割表のHTML生成
  let tableHTML = `<h2>${selectedClass}クラスの確定時間割</h2><table border="1"><tr><th></th><th>月</th><th>火</th><th>水</th><th>木</th><th>金</th></tr>`;

  for (const period of periods) {
    tableHTML += `<tr><td>${period}</td>`;
    for (const day of days) {
      const cellId = `${day}${period}`;
      const cell = document.getElementById(cellId);
      let value = "";

      if (cell.querySelector("select")) {
        value = cell.querySelector("select").value;
        if (!value || value === "") {
          value = "未選択";
        }
      } else {
        value = cell.textContent.trim() || "未設定";
      }

      tableHTML += `<td>${value}</td>`;
    }
    tableHTML += `</tr>`;
  }

  tableHTML += `</table>`;
  container.innerHTML = tableHTML;
}


</script>

</body>
</html>